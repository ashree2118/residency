generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(cuid())
  name           String
  email          String   @unique
  password       String
  profilePicture String?
  role           UserRole
  
  // For residents - which specific PG they belong to
  pgCommunityId String?
  pgCommunity   PgCommunity? @relation("PgResidents", fields: [pgCommunityId], references: [id])
  
  // For PG owners - the PG communities they own
  ownedPgCommunities PgCommunity[] @relation("PgOwnerCommunities")

  // Issues and services raised by this user (residents)
  raisedIssues      RaisedIssue[]
  requestedServices RequestedService[]
  
  // Events created by this user (owners)
  createdEvents Event[] @relation("EventCreator")
  
  // Event attendance and feedback
  eventAttendances EventAttendance[]
  eventFeedbacks   EventFeedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PgCommunity {
  id          String @id @default(cuid())
  name        String
  address     String
  description String?
  
  // Unique PG code for residents to use during signup
  pgCode      String @unique
  
  // Who owns this PG
  ownerId String
  owner   User   @relation("PgOwnerCommunities", fields: [ownerId], references: [id])
  
  // Residents in this PG
  residents User[] @relation("PgResidents")
  
  // Issues and services for this specific PG
  issues   RaisedIssue[]
  services RequestedService[]
  
  // Events for this PG
  events Event[]
  
  // Technicians available for this PG
  technicians TechnicianPgAssignment[]

  facilities PgFacility[]
  eventAnalytics EventAnalytic[]
  eventSuggestions EventSuggestion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PgFacility {
  id String @id @default(cuid())
  
  name String
  type FacilityType
  capacity Int?
  description String?
  isAvailable Boolean @default(true)
  amenities String[] // Array of amenities like "Projector", "Sound System", etc.
  
  pgCommunityId String
  pgCommunity PgCommunity @relation(fields: [pgCommunityId], references: [id], onDelete: Cascade)
  
  // Events that used this facility
  usedInEvents Event[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventAnalytic {
  id String @id @default(cuid())
  
  eventId String @unique
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  pgCommunityId String
  pgCommunity PgCommunity @relation(fields: [pgCommunityId], references: [id], onDelete: Cascade)
  
  // Attendance metrics
  totalRegistrations Int @default(0)
  actualAttendance Int @default(0)
  attendanceRate Float @default(0) // Percentage
  noShowCount Int @default(0)
  
  // Engagement metrics
  averageRating Float?
  totalFeedbacks Int @default(0)
  positiveFeedbackCount Int @default(0)
  negativeFeedbackCount Int @default(0)
  neutralFeedbackCount Int @default(0)
  
  // Engagement score (calculated based on attendance, ratings, feedback)
  engagementScore Float @default(0) // 0-100 scale
  
  // Cost and ROI
  eventCost Float?
  estimatedROI Float?
  
  // Social metrics
  photosShared Int @default(0)
  socialMentions Int @default(0)
  
  // Analysis insights
  successFactors String[] // What made this event successful
  improvementAreas String[] // Areas for improvement
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventSuggestion {
  id String @id @default(cuid())
  
  pgCommunityId String
  pgCommunity PgCommunity @relation(fields: [pgCommunityId], references: [id], onDelete: Cascade)
  
  // Suggestion details
  title String
  description String
  location String?
  suggestedEventType EventType
  suggestedDate DateTime?
  suggestedDuration Int? // in minutes
  
  // AI reasoning
  reasoning String // Why this event was suggested
  contextFactors String[] // Factors like "Weekend approaching", "Festival season", etc.
  
  // Based on past events
  basedOnEventIds String[] // IDs of past successful events this is based on
  expectedEngagement Float? // Predicted engagement score
  
  // Facility requirements
  requiredFacilities String[]
  recommendedCapacity Int?
  estimatedCost Float?
  
  // Status
  status SuggestionStatus @default(PENDING)
  implementedAsEventId String? // If the suggestion was implemented
  
  // Owner feedback
  ownerFeedback String?
  ownerRating Int? // 1-5 scale
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Technician {
  id          String          @id @default(cuid())
  name        String
  phoneNumber String
  speciality  TechnicianField
  isAvailable Boolean         @default(true)

  // Many-to-many relationship with PG communities
  pgAssignments TechnicianPgAssignment[]
  
  assignedIssues   RaisedIssue[]
  assignedServices RequestedService[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Junction table for Technician-PG relationships
model TechnicianPgAssignment {
  id String @id @default(cuid())
  
  technicianId String
  technician   Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)
  
  pgCommunityId String
  pgCommunity   PgCommunity @relation(fields: [pgCommunityId], references: [id], onDelete: Cascade)
  
  assignedAt DateTime @default(now())
  
  @@unique([technicianId, pgCommunityId])
}

model RaisedIssue {
  id            String        @id @default(cuid())
  ticketNumber  Int           @unique @default(autoincrement())
  title         String
  description   String
  issueType     IssueType
  priorityLevel PriorityLevel
  status        IssueStatus   @default(PENDING)
  location      String
  imageUrls     String[]

  // Who raised this issue (resident)
  raisedById String
  raisedBy   User   @relation(fields: [raisedById], references: [id])

  // Which PG community this belongs to
  pgCommunityId String
  pgCommunity   PgCommunity @relation(fields: [pgCommunityId], references: [id])

  assignedTechnicianId String?
  assignedTechnician   Technician? @relation(fields: [assignedTechnicianId], references: [id])

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?
}

model RequestedService {
  id            String        @id @default(cuid())
  ticketNumber  Int           @unique @default(autoincrement())
  title         String
  description   String
  serviceType   ServiceType
  priorityLevel PriorityLevel
  status        ServiceStatus @default(PENDING)
  location      String

  isApprovedByOwner Boolean @default(false)
  ownerComment      String?
  rejectionReason   String?

  // Who requested this service (resident)
  requestedById String
  requestedBy   User   @relation(fields: [requestedById], references: [id])

  // Which PG community this belongs to
  pgCommunityId String
  pgCommunity   PgCommunity @relation(fields: [pgCommunityId], references: [id])

  assignedTechnicianId String?
  assignedTechnician   Technician? @relation(fields: [assignedTechnicianId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  approvedAt  DateTime?
  completedAt DateTime?
}

model Event {
  id          String      @id @default(cuid())
  title       String
  description String?
  eventType   EventType
  location    String
  startDate   DateTime
  endDate     DateTime
  maxCapacity Int?
  
  // Event images/attachments
  imageUrls   String[]
  
  // Registration settings
  requiresRegistration Boolean @default(false)
  registrationDeadline DateTime?
  
  // NEW: Facility and cost tracking
  facilityId String?
  facility   PgFacility? @relation(fields: [facilityId], references: [id])
  estimatedCost Float?
  actualCost Float?
  
  // Who created this event (PG owner)
  createdById String
  createdBy   User @relation("EventCreator", fields: [createdById], references: [id])
  
  // Which PG community this belongs to
  pgCommunityId String
  pgCommunity   PgCommunity @relation(fields: [pgCommunityId], references: [id])
  
  // Event attendance and feedback
  attendances EventAttendance[]
  feedbacks   EventFeedback[]
  
  // NEW: Analytics relationship
  analytics EventAnalytic?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventAttendance {
  id String @id @default(cuid())
  
  userId String
  user   User @relation(fields: [userId], references: [id])
  
  eventId String
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  status AttendanceStatus @default(REGISTERED)
  registeredAt DateTime @default(now())
  attendedAt   DateTime?
  
  @@unique([userId, eventId])
}

model EventFeedback {
  id String @id @default(cuid())
  
  userId String
  user   User @relation(fields: [userId], references: [id])
  
  eventId String
  event   Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  rating      Int // 1-5 scale
  comment     String?
  feedbackType FeedbackType @default(GENERAL)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, eventId])
}

enum UserRole {
  PG_OWNER
  RESIDENT
}

enum TechnicianField {
  PLUMBING
  ELECTRICAL
  CARPENTRY
  CLEANING
  PAINTING
  AC_REPAIR
  APPLIANCE_REPAIR
  GENERAL_MAINTENANCE
}

enum IssueType {
  PLUMBING
  ELECTRICAL
  HEATING_COOLING
  CLEANING
  SECURITY
  INTERNET_WIFI
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  OTHER
}

enum ServiceType {
  CLEANING
  MAINTENANCE
  REPAIR
  INSTALLATION
  UPGRADE
  INSPECTION
  OTHER
}

enum PriorityLevel {
  P1 // Critical - Immediate attention
  P2 // High - Within 24 hours
  P3 // Medium - Within 3 days
  P4 // Low - Within a week
}

enum IssueStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  RESOLVED
}

enum ServiceStatus {
  PENDING
  AWAITING_APPROVAL
  APPROVED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  REJECTED
}

enum EventType {
  SOCIAL
  MAINTENANCE
  MEETING
  CELEBRATION
  WORKSHOP
  ANNOUNCEMENT
  FESTIVAL
  SPORTS
  CULTURAL
  EDUCATIONAL
  OTHER
}

enum AttendanceStatus {
  REGISTERED
  ATTENDED
  NO_SHOW
  CANCELLED
}

enum FeedbackType {
  GENERAL
  ORGANIZATION
  CONTENT
  VENUE
  TIMING
}

// NEW Enums
enum FacilityType {
  COMMON_ROOM
  ROOFTOP
  GARDEN
  PARKING_AREA
  DINING_HALL
  RECREATION_ROOM
  STUDY_ROOM
  GYM
  LIBRARY
  BALCONY
  COURTYARD
  OTHER
}

enum SuggestionStatus {
  PENDING
  APPROVED
  IMPLEMENTED
  REJECTED
  EXPIRED
}